<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Parent Geenee Auto-Welcome</title>

  <!-- 1) Load the Messenger first -->
  <link 
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"/>
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>

  <!-- 2) Debug + setup script -->
  <script>
    console.log("üîç Debug script loaded (head)");

    // A) Grab & decode email
    function parseEmail() {
      const v = new URLSearchParams(location.search).get("email")||"";
      try { return atob(v); } catch { return v; }
    }
    const userEmail = parseEmail();
    console.log("üìß Parsed email:", userEmail);

    // B) Poll until df-messenger-chat exists, then configure
    let attempts = 0;
    const timer = setInterval(() => {
      attempts++;
      const host = document.querySelector("df-messenger");
      const chat = host?.shadowRoot?.querySelector("df-messenger-chat");
      if (chat) {
        clearInterval(timer);
        console.log(`‚úÖ Messenger ready after ${attempts} checks`);

        // 1) Inject email as custom-data
        if (userEmail) {
          host.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
          console.log("üîó custom-data set ‚Üí", { email: userEmail });
        }

        // 2) Open the chat panel (this fires WELCOME)
        chat.setAttribute("open", "");
        console.log("üöÄ Chat opened (WELCOME should fire)");

        // 3) Log every outgoing/incoming payload
        host.addEventListener("df-request-sent", e =>
          console.log("‚ñ∂Ô∏è df-request-sent:", e.detail.body)
        );
        host.addEventListener("df-response-received", e =>
          console.log("‚óÄÔ∏è df-response-received:", e.detail.response)
        );
      }
      if (attempts > 50) {
        clearInterval(timer);
        console.error("‚ùå Messenger never became ready");
      }
    }, 100);
  </script>
</head>

<body>
  <!-- 3) The widget -->
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en">
  </df-messenger>
</body>
</html>
