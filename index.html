<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Parent Geenee Debug Chat</title>

  <!-- 1) Load the DF Messenger library before the element appears -->
  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    /* Always show the widget */
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>

  <!-- 2) Debug + email‐parse code runs early -->
  <script>
    console.log("🔍 Debug script loaded (head)");

    // Parse and decode email once
    function parseEmail() {
      const raw = new URLSearchParams(location.search).get("email") || "";
      try { return atob(raw); } catch { return raw; }
    }
    const userEmail = parseEmail();
    console.log("📧 Parsed email:", userEmail);

    // Poll until <df-messenger> has a shadowRoot
    let tries = 0;
    const poll = setInterval(() => {
      tries++;
      const df = document.querySelector("df-messenger");
      if (df && df.shadowRoot) {
        clearInterval(poll);
        console.log(`✅ df-messenger upgraded after ${tries} attempts`);

        // Inject email
        if (userEmail) {
          df.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
          console.log("🔗 custom-data set →", { email: userEmail });
        }

        // Log outgoing requests
        df.addEventListener("df-request-sent", e =>
          console.log("▶️ df-request-sent:", e.detail.body)
        );
        // Log incoming responses
        df.addEventListener("df-response-received", e =>
          console.log("◀️ df-response-received:", e.detail.response)
        );
      }
      if (tries > 50) {
        clearInterval(poll);
        console.warn("⌛ df-messenger never upgraded — shadowRoot still null");
      }
    }, 100);
  </script>
</head>

<body>
  <!-- 3) Now place the messenger tag -->
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en">
  </df-messenger>
</body>
</html>
