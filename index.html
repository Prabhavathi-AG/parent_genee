<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Parent Geenee Debug Chat</title>
  <style>
    /* Always show the widget */
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>

  <!-- 1) Early debug listener: registers BEFORE df-messenger.js loads -->
  <script>
    console.log("üîç Debug script loaded (before messenger.js)");

    // Parse email now
    function getQueryParam(n){ return new URLSearchParams(location.search).get(n); }
    let userEmail = getQueryParam("email") || "";
    try {
      userEmail = atob(userEmail);
      console.log("üìß Email decoded via Base64:", userEmail);
    } catch {
      console.log("üìß Email not Base64, using as-is:", userEmail);
    }

    // Set up our listener *early* so we don't miss it
    document.addEventListener("df-messenger-loaded", () => {
      console.log("‚úÖ (early) df-messenger-loaded event caught");

      const df = document.querySelector("df-messenger");
      if (!df) {
        console.error("‚ùå <df-messenger> not found");
        return;
      }

      // Inject email
      if (userEmail) {
        df.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
        console.log("üîó custom-data set ‚Üí", { email: userEmail });
      }

      // Log outgoing/incoming
      df.addEventListener("df-request-sent", e =>
        console.log("‚ñ∂Ô∏è df-request-sent:", e.detail.body)
      );
      df.addEventListener("df-response-received", e =>
        console.log("‚óÄÔ∏è df-response-received:", e.detail.response)
      );
    });

    // Fallback if we miss it
    setTimeout(() => {
      console.warn("‚åõÔ∏è 5s elapsed; if you saw no 'df-messenger-loaded' above, we missed it.");
    }, 5000);
  </script>

  <!-- 2) Now load the Dialogflow Messenger library -->
  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>
</head>

<body>
  <!-- 3) The chat widget -->
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en">
  </df-messenger>
</body>
</html>
