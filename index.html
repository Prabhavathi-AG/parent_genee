<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat with Parent Geenee</title>
  <link rel="icon" href="https://storage.googleapis.com/ui-images-pg/parent_genee_logo1.png" type="image/png">

  <style>
    body {
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #0a3195d2;
    }
    df-messenger {
      z-index: 999;
      position: fixed;
      background-color: #a854ccc2;
      display: none;  /* Initially hide the chat bubble */
      --df-messenger-chat-background: #d080e8dd;
      --df-messenger-input-padding: 8px;
    }
    @media (max-width: 991px) {
      df-messenger {
        position: fixed;
        --df-messenger-send-icon-offset-x: -12px;
        --df-messenger-input-inner-padding: 0px 64px 0px 0px;
        --df-messenger-input-padding: 12px 16px;
      }
    }
  </style>

  <!-- Load Dialogflow Messenger CSS & JS -->
  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <!-- 1) Extract and decode the `email` URL param -->
  <script>
    function getQueryParam(param) {
      return new URLSearchParams(window.location.search).get(param);
    }
    let userEmail = getQueryParam("email");
    if (userEmail) {
      try {
        userEmail = decodeURIComponent(atob(userEmail)); // Base64 â†’ string
      } catch (e) {
        console.log("Email not Base64, using as-is");
      }
    }
    console.log("Extracted User Email:", userEmail);
  </script>
</head>

<body>
  <!-- Dialogflow Chatbot Widget -->
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en"
    max-query-length="-1"
    allow-feedback="all">
    <df-messenger-chat-bubble
      chat-title="Parent Geenee"
      background-color="#74992e"
      bot-actor-image="https://storage.googleapis.com/ui-images-pg/chatbot-agent.png"
      user-actor-image="https://storage.googleapis.com/ui-images-pg/chatbot_user.png"
      chat-title-icon="https://storage.googleapis.com/ui-images-pg/parent_genee_logo1.png"
      chat-icon="https://storage.googleapis.com/ui-images-pg/parent_genee_logo1.png"
      allow-fullscreen="always">
    </df-messenger-chat-bubble>
  </df-messenger>

  <!-- 2) Open the chat bubble on load, keep your existing logic -->
  <script>
    window.addEventListener("load", function () {
      const chatBubble = document.querySelector("df-messenger");
      if (chatBubble) {
        chatBubble.style.display = "block"; // show it
        const chat = chatBubble.shadowRoot.querySelector("df-messenger-chat");
        chat.setAttribute("open", "");     // open it
        // hide the floating icon if you like
        chatBubble.shadowRoot
          .querySelector("df-messenger-chat-bubble")
          .style.display = "none";
      }
    });
  </script>

  <!-- 3) Swap session-params for custom-data -->
  <script>
    window.addEventListener("dfMessengerLoaded", () => {
      const dfMessenger = document.querySelector("df-messenger");
      // Optional: still set user-id if you use it for analytics
      if (userEmail) {
        dfMessenger.setAttribute("user-id", userEmail);
        // ðŸ”‘ This is what sends it as payload.customData.email
        dfMessenger.setAttribute(
          "custom-data",
          JSON.stringify({ email: userEmail })
        );
      }
    });
  </script>

  <!-- 4) Your Google API client + sentiment analysis (unchanged) -->
  <script>
    function initClient() {
      gapi.client.init({
        apiKey: 'AIzaSyANFDksC_jLSqbQOrCpvA_gTeTDB9V4Yq0',
        discoveryDocs: ['https://language.googleapis.com/$discovery/rest?version=v1']
      }).then(() => console.log('Google API client initialized'));
    }
    gapi.load('client', initClient);

    async function analyzeSentiment(text) {
      const response = await gapi.client.language.documents.analyzeSentiment({
        document: { content: text, type: 'PLAIN_TEXT' },
      });
      return response.result.documentSentiment;
    }

    function modifyResponse(sentiment, originalResponse) {
      if (sentiment.score < -0.5) {
        return `I'm sorry you're feeling frustrated. Let me help you with that. ${originalResponse}`;
      } else if (sentiment.score > 0.5) {
        return `Great! ${originalResponse}`;
      } else {
        return originalResponse;
      }
    }

    const dfMessenger = document.querySelector('df-messenger');
    dfMessenger.addEventListener('df-response-received', async (event) => {
      const userInput = event.detail.response.queryResult.queryText;
      const originalResponse = event.detail.response.queryResult.fulfillmentText;
      const sentiment = await analyzeSentiment(userInput);
      const modified = modifyResponse(sentiment, originalResponse);
      dfMessenger.renderCustomText(modified);
    });
  </script>
</body>
</html>
