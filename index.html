<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Parent Geenee Auto-Welcome</title>

  <!-- 1) Load the Dialogflow Messenger CSS & JS -->
  <link 
    rel="stylesheet" 
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    /* Pin the widget to the bottom-right */
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>
</head>
<body>

  <!-- 2) Add `intent="WELCOME"` to fire the start-flow without any manual open() call -->
  <df-messenger
    id="df"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en"
    intent="WELCOME">
  </df-messenger>

  <script>
    console.log("🐣 Script loaded");

    // A) Parse and Base64-decode the ?email query param
    const raw = new URLSearchParams(location.search).get("email") || "";
    let userEmail;
    try { userEmail = atob(raw); }
    catch { userEmail = raw; }
    console.log("📧 Parsed email:", userEmail);

    // B) Wait until the element class is registered
    customElements.whenDefined("df-messenger").then(() => {
      console.log("✅ <df-messenger> defined");

      const df = document.getElementById("df");

      // 1) Wire up logging so we can see the payloads
      df.addEventListener("df-request-sent", e =>
        console.log("▶️ df-request-sent:", e.detail)
      );
      df.addEventListener("df-response-received", e =>
        console.log("◀️ df-response-received:", e.detail)
      );

      // 2) Inject your email into custom-data *before* the WELCOME intent fires
      if (userEmail) {
        df.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
        console.log("🔗 custom-data set →", { email: userEmail });
      }

      // No need to call openChat(); intent="WELCOME" does that for us.
    });
  </script>

</body>
</html>
