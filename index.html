<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Parent Geenee Debug Chat</title>

  <!-- 1) Dialogflow Messenger CSS -->
  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <style>
    /* Always show the widget in the corner */
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>
</head>
<body>
  <!-- 2) The chatbot widget -->
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en">
  </df-messenger>

  <!-- 3) Load the DF messenger script -->
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <!-- 4) Debug & emailâ€injection logic -->
  <script>
    console.log("ğŸ” Debug script loaded");

    // 4a) Parse email from ?email=, Base64â€decode if needed
    function getQueryParam(n) {
      return new URLSearchParams(location.search).get(n);
    }
    let userEmail = getQueryParam("email") || "";
    try {
      userEmail = atob(userEmail);
      console.log("ğŸ“§ Email decoded via Base64:", userEmail);
    } catch {
      console.log("ğŸ“§ Email not Base64, using as-is:", userEmail);
    }

    // 4b) When the <df-messenger> is in DOM with a shadowRoot, call this:
    function onMessengerReady(df) {
      console.log("âœ… df-messenger detected and ready");

      // Inject the email into custom-data
      if (userEmail) {
        df.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
        console.log("ğŸ”— custom-data set â†’", { email: userEmail });
      }

      // Log outgoing requests
      df.addEventListener("df-request-sent", evt => {
        console.log("â–¶ï¸ df-request-sent:", evt.detail.body);
      });

      // Log incoming responses
      df.addEventListener("df-response-received", evt => {
        console.log("â—€ï¸ df-response-received:", evt.detail.response);
      });
    }

    // 4c) Poll until the messenger element+shadowRoot exist
    const checkInterval = setInterval(() => {
      const df = document.querySelector("df-messenger");
      if (df && df.shadowRoot) {
        clearInterval(checkInterval);
        onMessengerReady(df);
      }
    }, 100);

    // Fallback log if it never appears
    setTimeout(() => {
      if (checkInterval) {
        console.warn("âŒ›ï¸ Chat widget still not ready after 5s");
      }
    }, 5000);
  </script>
</body>
</html>
