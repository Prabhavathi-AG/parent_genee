<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Parent Geenee Auto-Welcome</title>

  <!-- 1) Load the Dialogflow CX messenger first -->
  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    /* Always keep the widget visible */
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>

  <!-- 2) Your debug + setup script -->
  <script>
    console.log("üîç Debug script loaded");

    // A) Extract & decode email
    function parseEmail() {
      const raw = new URLSearchParams(location.search).get("email") || "";
      try { return atob(raw); } catch { return raw; }
    }
    const userEmail = parseEmail();
    console.log("üìß Parsed email:", userEmail);

    // B) Once messenger is upgraded, run setup
    let tries = 0;
    const handleReady = df => {
      console.log(`‚úÖ Messenger ready after ${tries} checks`);

      // 1. inject email into custom-data
      if (userEmail) {
        df.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
        console.log("üîó custom-data set ‚Üí", { email: userEmail });
      }

      // 2. open the chat UI
      df.openChat();

      // 3. Fire the WELCOME event *programmatically*
      //    This triggers your Start page webhook without the user typing.
      df.sendEvent("WELCOME");
      console.log("üöÄ Sent WELCOME event");

      // 4. Log request/response
      df.addEventListener("df-request-sent", e =>
        console.log("‚ñ∂Ô∏è df-request-sent:", e.detail.body)
      );
      df.addEventListener("df-response-received", e =>
        console.log("‚óÄÔ∏è df-response-received:", e.detail.response)
      );
    };

    // C) Poll until the <df-messenger> and its shadowRoot appear
    const poll = setInterval(() => {
      tries++;
      const df = document.querySelector("df-messenger");
      if (df?.shadowRoot) {
        clearInterval(poll);
        handleReady(df);
      }
      if (tries > 50) {
        clearInterval(poll);
        console.error("‚ùå Messenger never became ready");
      }
    }, 100);
  </script>
</head>

<body>
  <!-- 3) The chatbot placeholder -->
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en">
  </df-messenger>
</body>
</html>
