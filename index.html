<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Parent Geenee Debug Chat</title>

  <!-- 1) Dialogflow Messenger CSS & JS -->
  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    /* Always show the widget in the corner */
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>
</head>
<body>
  <!-- 2) The chatbot widget -->
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en">
  </df-messenger>

  <!-- 3) Debug and email-injection script -->
  <script>
    // 3a) Step 0: Verify this script runs at all
    console.log("üîç Debug script loaded");

    // 3b) Extract & decode the email param
    function getQueryParam(n){ return new URLSearchParams(location.search).get(n) }
    let userEmail = getQueryParam("email");
    if (userEmail) {
      try {
        userEmail = decodeURIComponent(atob(userEmail));
      } catch {
        console.log("Email not Base64, using as-is");
      }
    }
    console.log("üìß User email parsed as:", userEmail);

    // 3c) Listen for the df-messenger-loaded event on document
    document.addEventListener("df-messenger-loaded", () => {
      console.log("‚úÖ df-messenger-loaded fired");

      // Find the messenger element
      const df = document.querySelector("df-messenger");
      if (!df) {
        console.error("‚ùå <df-messenger> element not found");
        return;
      }

      // 3d) Inject the email into custom-data
      if (userEmail) {
        console.log("üîó Setting custom-data =", { email: userEmail });
        df.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
      }

      // 3e) Log every outgoing request
      df.addEventListener("df-request-sent", evt => {
        console.log("‚ñ∂Ô∏è df-request-sent:", evt.detail.body);
      });

      // 3f) Log every incoming response
      df.addEventListener("df-response-received", evt => {
        console.log("‚óÄÔ∏è df-response-received:", evt.detail.response);
      });
    });

    // 3g) Fallback in case the event never fires
    setTimeout(() => {
      console.warn("‚åõÔ∏è 5s passed and no df-messenger-loaded event?");
    }, 5000);
  </script>
</body>
</html>
