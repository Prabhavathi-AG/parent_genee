<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Parent Geenee Auto-Welcome</title>

  <!-- 1) Load the Dialogflow Messenger CSS & JS BEFORE the element -->
  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>

  <style>
    /* Always keep the widget visible in the corner */
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>

  <!-- 2) Our debug + auto-welcome script -->
  <script>
    console.log("üîç Debug script loaded (head)");

    // A) Extract & decode the email query-param
    function parseEmail() {
      const raw = new URLSearchParams(location.search).get("email") || "";
      try { return atob(raw); } catch { return raw; }
    }
    const userEmail = parseEmail();
    console.log("üìß Parsed email:", userEmail);

    // B) Poll until the df-messenger component has fully upgraded
    let checks = 0;
    const handle = setInterval(() => {
      checks++;
      const host = document.querySelector("df-messenger");
      const chat = host?.shadowRoot?.querySelector("df-messenger-chat");

      if (chat) {
        clearInterval(handle);
        console.log(`‚úÖ Messenger ready after ${checks} checks`);

        // 1) Inject the email into custom-data
        if (userEmail) {
          host.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
          console.log("üîó custom-data set ‚Üí", { email: userEmail });
        }

        // 2) Open the chat panel (this automatically fires WELCOME)
        chat.setAttribute("open", "");
        console.log("üöÄ Chat opened (WELCOME event sent)");

        // 3) Log every outgoing request
        host.addEventListener("df-request-sent", e =>
          console.log("‚ñ∂Ô∏è df-request-sent:", e.detail.body)
        );
        // 4) Log every incoming response
        host.addEventListener("df-response-received", e =>
          console.log("‚óÄÔ∏è df-response-received:", e.detail.response)
        );
      }

      // After 50 tries (~5s), give up
      if (checks > 50) {
        clearInterval(handle);
        console.error("‚ùå Messenger never became ready");
      }
    }, 100);
  </script>
</head>

<body>
  <!-- 3) This tag is where the widget goes -->
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en">
  </df-messenger>
</body>
</html>
