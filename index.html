<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Parent Geenee Polling Debug</title>
  <style>
    df-messenger {
      position: fixed !important;
      bottom: 0 !important;
      right: 0 !important;
      z-index: 999 !important;
    }
  </style>
  <!-- Load the Messenger library -->
  <link
    rel="stylesheet"
    href="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/themes/df-messenger-default.css"
  />
  <script src="https://www.gstatic.com/dialogflow-console/fast/df-messenger/prod/v1/df-messenger.js"></script>
</head>
<body>
  <df-messenger
    id="chatbot"
    project-id="parent-geenee-dev-445110"
    agent-id="c6b2330d-fb94-4a93-9b2d-c5716ad2de36"
    language-code="en">
  </df-messenger>

  <script>
    console.log("ðŸ” Debug script loaded");

    // Extract and decode email
    function parseEmail() {
      const p = new URLSearchParams(location.search).get("email") || "";
      try { return atob(p); } catch { return p; }
    }
    const userEmail = parseEmail();
    console.log("ðŸ“§ Parsed email:", userEmail);

    // Polling function to wait for the df-messenger to be fully in the DOM
    let attempts = 0;
    const poll = setInterval(() => {
      attempts++;
      const df = document.querySelector("df-messenger");
      // The Chat component lives inside shadowRoot as <df-messenger-chat>
      const chat = df?.shadowRoot?.querySelector("df-messenger-chat");

      if (df && chat) {
        clearInterval(poll);
        console.log(`âœ… Messenger ready after ${attempts} checks`);

        // Inject email into custom-data
        if (userEmail) {
          df.setAttribute("custom-data", JSON.stringify({ email: userEmail }));
          console.log("ðŸ”— custom-data set â†’", { email: userEmail });
        }

        // Log outgoing requests
        df.addEventListener("df-request-sent", e =>
          console.log("â–¶ï¸ df-request-sent:", e.detail.body)
        );

        // Log incoming responses
        df.addEventListener("df-response-received", e =>
          console.log("â—€ï¸ df-response-received:", e.detail.response)
        );
      }

      // After 20 attempts (~2s), warn if still not ready
      if (attempts > 20) {
        clearInterval(poll);
        console.warn("âŒ› Messenger still not ready after 20 checks");
      }
    }, 100);
  </script>
</body>
</html>
